<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Record Audio and Upload to Google Drive</title>
    <style>
        #status {
            display: none;
            margin-top: 10px;
        }
        #microphone-icon {
            display: none;
            font-size: 24px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>Record Audio and Upload to Google Drive</h1>
    <button id="recordButton">Start Recording</button>
    <span id="status">Recording <span id="microphone-icon">ðŸŽ¤</span></span>

    <!-- New GIS script -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        const recordButton = document.getElementById('recordButton');
        const status = document.getElementById('status');
        const microphoneIcon = document.getElementById('microphone-icon');

        recordButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        audioChunks = [];
                        handleAuthClick(audioBlob);
                    });

                    isRecording = true;
                    recordButton.textContent = 'Stop Recording';
                    status.style.display = 'inline';
                    microphoneIcon.style.display = 'inline';
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            recordButton.textContent = 'Start Recording';
            status.style.display = 'none';
            microphoneIcon.style.display = 'none';
        }

        function handleAuthClick(blob) {
            google.accounts.id.initialize({
                client_id: '305229200010-tb2rufv2s4cqstbevq3n8co4rl5h8nfn.apps.googleusercontent.com',
                callback: (response) => {
                    uploadToGoogleDrive(blob, response.credential);
                }
            });

            google.accounts.id.prompt(); // Display the One Tap UI
        }

        function uploadToGoogleDrive(blob, token) {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const base64data = reader.result.split(',')[1];

                // Initialize the Google API client
                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        apiKey: 'AIzaSyBPn9zs5JdmEvQ5tUmG0azSLL_R590W-MI',
                        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                    }).then(() => {
                        // Ensure the auth instance is available
                        gapi.auth2.init().then(() => {
                            const authInstance = gapi.auth2.getAuthInstance();
                            if (authInstance) {
                                authInstance.currentUser.get().reloadAuthResponse().then(authResponse => {
                                    authInstance.setToken({ access_token: authResponse.access_token });
                                    const fileMetadata = {
                                        'name': 'recording.wav',
                                        'parents': ['1OLSxqrewxO-F4YI3PED-K0UMYaGhrXXd'] // Replace with your folder ID
                                    };
                                    const media = {
                                        mimeType: 'audio/wav',
                                        body: new Blob([new Uint8Array(atob(base64data).split("").map((char) => char.charCodeAt(0)))])
                                    };
                                    gapi.client.drive.files.create({
                                        resource: fileMetadata,
                                        media: media,
                                        fields: 'id'
                                    }).then((response) => {
                                        console.log('File uploaded successfully, ID: ', response.result.id);
                                    }, (error) => {
                                        console.error('Error uploading file: ', error);
                                    });
                                });
                            } else {
                                console.error('Auth instance not initialized.');
                            }
                        }).catch((error) => {
                            console.error('Error initializing Google Auth2: ', error);
                        });
                    }).catch((error) => {
                        console.error('Error initializing Google API client: ', error);
                    });
                });
            };
        }
    </script>
</body>
</html>