<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Tracker</title>
</head>
<body>
    <h1>Audio Tracker</h1>
    <audio id="audio1" controls>
        <source src="https://englishhiro.github.io/AudioFolder/1.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    <br>
    <audio id="audio2" controls>
        <source src="https://englishhiro.github.io/AudioFolder/3.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    <br>
    <audio id="audio3" controls>
        <source src="https://englishhiro.github.io/AudioFolder/4.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <script>
        function logListeningData(audioId, user, audioFile, duration) {
            const url = 'https://script.google.com/macros/s/AKfycbwB8fv1zLSdqthF8uph-hSKg0zasrqHbGhX1KDN4Q8M-OVrltlGkYeG8uMfP0PBG97e/exec';
            const data = {
                timestamp: new Date().toISOString(),
                user: user,
                audioFile: audioFile,
                duration: duration
            };
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                console.log('Data logged successfully:', data);
            }).catch(error => {
                console.error('Error logging data:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            const user = 'User1'; // Replace with dynamic user info if needed

            const audioElements = document.querySelectorAll('audio');
            audioElements.forEach(audio => {
                let startTime;
                let silenceTimeout;
                let recognition;
                
                function resetSilenceTimeout() {
                    if (silenceTimeout) clearTimeout(silenceTimeout);
                    silenceTimeout = setTimeout(() => {
                        audio.pause();
                        recognition.stop();
                        console.log('Recording stopped due to 30 seconds of silence.');
                    }, 30000);
                }

                audio.addEventListener('play', () => {
                    startTime = new Date().getTime();
                    
                    // Start speech recognition
                    if (!('webkitSpeechRecognition' in window)) {
                        console.log('Speech recognition not supported.');
                        return;
                    }
                    recognition = new webkitSpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;

                    recognition.onresult = (event) => {
                        resetSilenceTimeout();
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                    };

                    recognition.onend = () => {
                        console.log('Speech recognition ended.');
                    };

                    recognition.start();
                    resetSilenceTimeout();
                });

                audio.addEventListener('pause', () => {
                    if (startTime) {
                        const duration = (new Date().getTime() - startTime) / 1000;
                        logListeningData(audio.id, user, audio.querySelector('source').src, duration);
                        startTime = null;
                        if (recognition) recognition.stop();
                        clearTimeout(silenceTimeout);
                    }
                });

                audio.addEventListener('ended', () => {
                    if (startTime) {
                        const duration = (new Date().getTime() - startTime) / 1000;
                        logListeningData(audio.id, user, audio.querySelector('source').src, duration);
                        startTime = null;
                        if (recognition) recognition.stop();
                        clearTimeout(silenceTimeout);
                    }
                });
            });
        });
    </script>
</body>
</html>
